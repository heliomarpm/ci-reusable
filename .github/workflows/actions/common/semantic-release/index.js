const core = require('@actions/core');
const exec = require('@actions/exec');
const fs = require('fs');
const path = require('path');

async function run() {
  try {
    const githubToken = core.getInput('github_token', { required: true });
    const npmToken = core.getInput('npm_token');
    const debug = core.getInput('debug') === 'true' ? '--debug' : '';
    const configPath = core.getInput('config_path');
    const actionDir = path.join(__dirname, '..', '..', '..', '..', '..', '.github', 'workflows', 'actions', 'common', 'semantic-release');
    const consumerRepoDir = process.cwd();

    // 1. Configurar Tokens
    core.exportVariable('GITHUB_TOKEN', githubToken);
    if (npmToken) {
      core.exportVariable('NPM_TOKEN', npmToken);
    }

    // 2. L√≥gica H√≠brida de Configura√ß√£o
    let releaseConfigPath = '';
    const consumerConfigPath = path.join(consumerRepoDir, 'release.config.js');
    
    if (fs.existsSync(consumerConfigPath)) {
      core.info('‚úÖ release.config.js encontrado no reposit√≥rio consumidor. Usando configura√ß√£o local.');
      releaseConfigPath = consumerConfigPath;
    } else {
      core.info('‚ö†Ô∏è release.config.js n√£o encontrado no reposit√≥rio consumidor. Usando configura√ß√£o padr√£o do template.');
      // O configPath aponta para o release.config.js padr√£o (ou alternativo) dentro da action
      releaseConfigPath = path.join(consumerRepoDir, configPath);
    }
    
    // 3. Instalar Depend√™ncias (Action e Plugins)
    core.info('üì• Instalando depend√™ncias e plugins do semantic-release...');
    // Instala as depend√™ncias listadas no package.json (devDependencies) da action
    await exec.exec(`npm install --prefix ${actionDir}`);
    
    // 4. Executar semantic-release
    core.info('üöÄ Executando semantic-release...');
    
    // Caminho para o bin√°rio do semantic-release instalado na action
    const semanticReleaseBin = path.join(actionDir, 'node_modules', '.bin', 'semantic-release');
    
    // Comando final de execu√ß√£o
    const command = [
      semanticReleaseBin,
      '-p',
      releaseConfigPath,
      debug
    ].join(' ').trim();
    
    await exec.exec(command, [], {
        env: { ...process.env, 
               GITHUB_TOKEN: githubToken,
               NPM_TOKEN: npmToken 
        }
    });

    core.info('üéâ Semantic release conclu√≠do.');

  } catch (error) {
    core.setFailed(error.message);
  }
}

run();