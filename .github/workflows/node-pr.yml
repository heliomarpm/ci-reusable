# Workflow de Pull Request Automatizado para Node.js
# Cria ou atualiza um PR (develop -> main) e inclui o resumo de cobertura se disponível.
name: Node.js Auto Pull Request

on:
  workflow_call:
    inputs:
      base_branch:
        description: "Branch de destino do PR (e.g., main)."
        required: false
        default: "main"
        type: string

      head_branch:
        description: "Branch de origem do PR (e.g., develop)."
        required: false
        default: "develop"
        type: string

      pr_title:
        description: "Título do Pull Request."
        required: false
        type: string
        default: null
        # default: 'Merge Automático: ${{ github.ref_name }} para ${{ inputs.base_branch }}'

      report_coverage_command:
        description: "Comando para executar testes e garantir que o coverage/coverage-summary.json seja gerado."
        required: false
        default: "npm test -- --coverage --outputFile=coverage/coverage-summary.json"
        type: string

      coverage_summary_path:
        description: "Caminho para o coverage-summary.json (default: coverage/coverage-summary.json)."
        required: false
        default: "coverage/coverage-summary.json"
        type: string

    secrets:
      GH_TOKEN:
        description: "Token GITHUB_TOKEN para permissões de PR."
        required: true

permissions:
  contents: write # Necessário para operações gerais de escrita (embora o PR use o API, é bom para a Action)
  pull-requests: write # ESSENCIAL: Concede permissão para criar e manipular Pull Requests.
  actions: write

jobs:
  create_or_update_pr:
    name: Criar/Atualizar PR (develop -> main)
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do Repositório Consumidor
      # Necessário para baixar artefatos e garantir que estamos no repo correto.
      - name: ⬇️ Checkout do Código Consumidor
        uses: actions/checkout@v4

      # 2. Setup Node.js (necessário para NPM e para rodar a Action PR)
      - name: ⚙️ Configurar Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      # 3. Instalar Dependências (do projeto consumidor)
      - name: 📥 Instalar Dependências do Projeto Consumidor
        run: npm install

      # 4. Reexecutar Testes e Gerar Cobertura (Garante que o JSON está no local certo)
      - name: 🧪 Gerar Resumo de Cobertura (Localmente)
        run: ${{ inputs.report_coverage_command }}

      # 5. Checkout do Repositório de Templates (Onde a Action 'pr' vive)
      # ESSENCIAL: Clonamos o repositório 'ci-reusable' em uma subpasta 'templates-repo'
      - name: ⬇️ Checkout do Repositório de Templates (Actions)
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/ci-reusable # Seu repositório de templates
          ref: "main" # ${{ github.ref }} # Mantém a referência da branch de chamada
          path: templates-repo
          token: ${{ secrets.GH_TOKEN }} # Necessário se o repositório for privado

      # 6. Instalar as dependências da Action PR
      # - name: 📥 Instalar Dependências da Action PR
      #   run: npm install
      #   # Entra no diretório da action e executa 'npm install'
      #   working-directory: templates-repo/.github/workflows/actions/common/pr

      # - name: 📥 Baixar Resumo de Cobertura (Opcional)
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: coverage-report
      #     path: . # Necessário conforme foi publicado no node-test.yml
      #     run-id: ${{ github.run_id }} # Força a Action a procurar o artefato nesta execução
      #     github-token: ${{ secrets.GH_TOKEN }}
      #   continue-on-error: true

      # 7. Criar ou Atualizar Pull Request
      - name: 🤖 Criar ou Atualizar Pull Request
        uses: ./templates-repo/.github/workflows/actions/common/pr
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          base_branch: ${{ inputs.base_branch }}
          head_branch: ${{ inputs.head_branch }}
          pr_title: ${{ inputs.pr_title }}
          coverage_summary_path: ${{ inputs.coverage_summary_path }}
