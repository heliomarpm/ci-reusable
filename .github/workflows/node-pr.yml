# Workflow de Pull Request Automatizado para Node.js
# Cria ou atualiza um PR (develop -> main) e inclui o resumo de cobertura se dispon√≠vel.
name: Node.js Auto Pull Request

on:
  workflow_call:
    inputs:
      base_branch:
        description: "Branch de destino do PR (e.g., main)."
        required: false
        default: "main"
        type: string

      head_branch:
        description: "Branch de origem do PR (e.g., develop)."
        required: false
        default: "develop"
        type: string

      pr_title:
        description: "T√≠tulo do Pull Request."
        required: false
        type: string
        default: null
        # default: 'Merge Autom√°tico: ${{ github.ref_name }} para ${{ inputs.base_branch }}'

      test_coverage_command: 
        description: 'Comando para executar testes e garantir que o coverage-summary seja gerado para o corpo do PR.'
        required: false
        default: 'npm test -- --coverage --no-watch'
        type: string

      coverage_summary_path:
        description: "Caminho para o coverage-summary.json (default: coverage/coverage-summary.json)."
        required: false
        default: "coverage/coverage-summary.json"
        type: string

    secrets:
      GH_TOKEN:
        description: "Token GITHUB_TOKEN para permiss√µes de PR."
        required: true

jobs:
  create_or_update_pr:
    name: Criar/Atualizar PR (develop -> main)
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Necess√°rio para opera√ß√µes gerais de escrita
      pull-requests: write  # ESSENCIAL: Concede permiss√£o para criar e manipular Pull Requests.
      actions: read         # read para o contexto

    steps:
      - name: ‚¨áÔ∏è Checkout do C√≥digo Consumidor
        uses: actions/checkout@v4
        with:
          # Necess√°rio para evitar falhas do gh CLI em reposit√≥rios grandes
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: üì• Instalar Depend√™ncias do Projeto Consumidor
        run: npm install

      - name: üì• Instalar GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: üîê Autenticar GitHub CLI e Criar Labels
        run: |
          # Autentica o gh CLI usando o GH_TOKEN
          # O 'gh auth status' verifica se a autentica√ß√£o funcionou
          # echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token --hostname github.com
          gh auth setup-git
          
          # Garante que as labels existam (usando || true para n√£o falhar se a label j√° existir)
          gh label create "auto-generated" --description "PR criado automaticamente" --color "0E8A16" || true
          # gh label create "pending-review" --description "Aguardando revis√£o" --color "FBCA04" || true
        env:
          # O token √© necess√°rio para os comandos 'gh'
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: üìä Gerar Cobertura e Body do PR
        # Executa testes e salva a sa√≠da em um arquivo tempor√°rio
        run: |
          # Executa o comando de teste fornecido pelo input
          ${{ inputs.test_coverage_command }} > coverage-report.txt 2>&1 || true

          # Formata o t√≠tulo com data (se o input for o default)
          PR_TITLE="${{ inputs.pr_title }}"
          if [[ "$PR_TITLE" == "" ]]; then
            PR_TITLE="üîÄ ${{ inputs.head_branch }} ‚Üí ${{ inputs.base_branch }}: $(date +'%Y-%m-%d')"
          fi

          # Extrai a tabela de cobertura do Jest (assumindo que Jest √© o runner)
          COV_TABLE=$(awk '/^--/ {flag=1; next} flag {print}' coverage-report.txt | head -n -3)
          
          # Cria o corpo do PR
          echo "## üöÄ Pull Request Automatizado" > pr_body.md
          echo "" >> pr_body.md
          echo "Este Pull Request foi criado/atualizado automaticamente pelo fluxo CI/CD para integrar as mudan√ßas da branch **`${{ inputs.head_branch  }}`** na branch **`${{ inputs.base_branch  }}`**." >> pr_body.md
          echo "---" >> pr_body.md
          echo "### üìã Resumo das Mudan√ßas" >> pr_body.md
          echo "Todos os commits entre as branches foram inclu√≠dos. Por favor, revise as altera√ß√µes e verifique o status dos checks de CI/CD." >> pr_body.md

          echo "### üìä Resultado da Cobertura de Testes" >> pr_body.md
          echo "\`\`\`" >> pr_body.md
          echo "$COV_TABLE" >> pr_body.md
          echo "\`\`\`" >> pr_body.md
          echo "---" >> pr_body.md
          echo "### üìã Checklist da entrega" >> pr_body.md
          echo "" >> pr_body.md
          echo "**Desenvolvedor**:" >> pr_body.md
          echo "- [ ] Confirmo que os testes passaram." >> pr_body.md
          echo "- [ ] Confirmo que a documenta√ß√£o foi atualizada." >> pr_body.md

          echo "" >> pr_body.md
          echo "**Revisor**:" >> pr_body.md
          echo "- [ ] O c√≥digo segue os padr√µes do projeto." >> pr_body.md
          echo "- [ ] A funcionalidade est√° correta." >> pr_body.md
         
          # Passa o t√≠tulo corrigido para o ambiente para uso posterior
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV

      - name: ü§ñ Criar ou Atualizar Pull Request
        run: |
          # Tenta encontrar um PR existente
          PR_NUMBER=$(gh pr list --base ${{ inputs.base_branch }} --head ${{ inputs.head_branch }} --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            # Se n√£o houver PR, cria uma nova
            echo "Nenhuma PR encontrada, criando nova PR..."
            gh pr create \
              --base ${{ inputs.base_branch }} \
              --head ${{ inputs.head_branch }} \
              --title "$PR_TITLE" \
              --body-file pr_body.md \
              --label "auto-generated,pending-review" \
              --assignee "${{ github.actor }}"
          else
            # Se a PR j√° existir, atualiza o corpo
            echo "Encontrado PR aberto com o n√∫mero $PR_NUMBER, atualizando corpo e designados..."
            gh pr edit $PR_NUMBER \
              --body-file pr_body.md \
              --add-assignee "${{ github.actor }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}