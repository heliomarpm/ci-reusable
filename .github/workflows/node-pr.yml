# Workflow de Pull Request Automatizado para Node.js
# Cria ou atualiza um PR (develop -> main) e inclui o resumo de cobertura se disponÃ­vel.
name: Node.js Auto Pull Request

on:
  workflow_call:
    inputs:
      base_branch:
        description: 'Branch de destino do PR (e.g., main).'
        required: false
        default: 'main'
        type: string
      head_branch:
        description: 'Branch de origem do PR (e.g., develop).'
        required: false
        default: 'develop'
        type: string
    secrets:
      PR_TOKEN:
        description: 'Token GITHUB_TOKEN para permissÃµes de PR.'
        required: true

permissions:
  contents: write       # NecessÃ¡rio para operaÃ§Ãµes gerais de escrita (embora o PR use o API, Ã© bom para a Action)
  pull-requests: write  # ESSENCIAL: Concede permissÃ£o para criar e manipular Pull Requests.
  actions: write

jobs:
  create_or_update_pr:
    name: Criar/Atualizar PR (develop -> main)
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do RepositÃ³rio Consumidor
      # NecessÃ¡rio para baixar artefatos e garantir que estamos no repo correto.
      - name: â¬‡ï¸ Checkout do CÃ³digo Consumidor
        uses: actions/checkout@v4

      # 2. Checkout do RepositÃ³rio de Templates (Onde a Action 'pr' vive)
      # ESSENCIAL: Clonamos o repositÃ³rio 'ci-reusable' em uma subpasta 'templates-repo'
      - name: â¬‡ï¸ Checkout do RepositÃ³rio de Templates (Actions)
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/ci-reusable # Seu repositÃ³rio de templates
          ref: 'main' # ${{ github.ref }} # MantÃ©m a referÃªncia da branch de chamada
          path: templates-repo
          token: ${{ secrets.PR_TOKEN }} # NecessÃ¡rio se o repositÃ³rio for privado

      # 3. â­ï¸ CORREÃ‡ÃƒO: Instalar as dependÃªncias da Action PR â­ï¸
      - name: ğŸ“¥ Instalar DependÃªncias da Action PR
        run: npm install
        # Entra no diretÃ³rio da action e executa 'npm install'
        working-directory: templates-repo/.github/workflows/actions/common/pr

      - name: ğŸ“¥ Baixar Resumo de Cobertura (Opcional)
        uses: actions/download-artifact@v4
        with:
          name: coverage-summary
          path: coverage # O local onde foi publicado no test.yml
        continue-on-error: true 

      - name: ğŸ¤– Criar ou Atualizar Pull Request
        uses: ./templates-repo/.github/workflows/actions/common/pr
        with:
          github_token: ${{ secrets.PR_TOKEN }}
          base_branch: ${{ inputs.base_branch }}
          head_branch: ${{ inputs.head_branch }}
          coverage_summary_path: coverage/coverage-summary.json